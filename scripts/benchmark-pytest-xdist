#!/bin/bash

#
# Usage: benchmark-pytest-xdist.sh n_runs n_workers dist_type [pytest_args]
#
n_runs=$1
n_workers=$2
dist=$3

source "${BASH_SOURCE%/*}/../bin/.helpers.sh"

for ((i = 1; i < n_workers + 1; i++)); do
  tmpfile=$(mktemp /tmp/benchmark-pytest-xdist.XXXXXX)

  for ((j = 1; j < n_runs + 1; j++)); do
    docker exec backend_myapp_dev /bin/bash -c "pytest -n $i --dist $dist" 2>&1 | grep "===========" >>"$tmpfile"
  done
  total_time=$(grep -o '[0-9]*\.[0-9]*s' "$tmpfile" | awk '{sum+=$1} END {print sum}')
  average_time=$(echo "scale=2; $total_time / $n_runs" | bc)
  log "Average time spent for $n_runs runs with $i workers: $average_time s" >>./benchmark-pytest-xdist.log
  rm "$tmpfile"
done
